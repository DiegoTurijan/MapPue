<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transportes Puebla</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.1/dist/leaflet-routing-machine.css" />
<link rel="manifest" href="manifest.json">
<style>
:root {
--primary-color: #007AFF;
--secondary-color: #34C759;
--background-color: #F2F2F7;
--card-color: #FFFFFF;
--text-primary: #1C1C1E;
--text-secondary: #8E8E93;
--border-radius: 12px;
--shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
margin: 0;
padding: 0;
display: flex;
flex-direction: column;
align-items: center;
background-color: var(--background-color);
min-height: 100vh;
position: relative;
padding-bottom: 56px;
box-sizing: border-box;
color: var(--text-primary);
}

.container {
width: 90%;
max-width: 800px;
background-color: var(--card-color);
border-radius: var(--border-radius);
padding: 20px;
margin-top: 20px;
box-shadow: var(--shadow);
margin-bottom: 76px;
}

h1 {
text-align: center;
margin-bottom: 20px;
font-weight: 600;
color: var(--text-primary);
}

.search-container {
position: relative;
margin-bottom: 20px;
}

.search-bar {
background-color: rgba(142, 142, 147, 0.12);
border-radius: 10px;
padding: 8px 12px;
display: flex;
align-items: center;
transition: all 0.2s;
}

.search-bar:focus-within {
background-color: rgba(142, 142, 147, 0.18);
}

.search-bar input[type="text"] {
border: none;
background: transparent;
width: 100%;
padding: 6px;
outline: none;
flex-grow: 1;
font-size: 16px;
color: var(--text-primary);
}

.search-bar input[type="text"]::placeholder {
color: var(--text-secondary);
}

.search-button {
background: none;
border: none;
cursor: pointer;
display: none;
padding: 5px;
color: var(--primary-color);
}

.suggestions-container {
position: absolute;
top: 100%;
left: 0;
right: 0;
background-color: var(--card-color);
border-radius: 0 0 var(--border-radius) var(--border-radius);
box-shadow: var(--shadow);
z-index: 1000;
max-height: 200px;
overflow-y: auto;
display: none;
border-top: 1px solid rgba(142, 142, 147, 0.1);
}

.suggestion-item {
padding: 12px 16px;
cursor: pointer;
border-bottom: 1px solid rgba(142, 142, 147, 0.1);
transition: background-color 0.2s;
}

.suggestion-item:hover {
background-color: rgba(142, 142, 147, 0.08);
}

.suggestion-item .line {
font-size: 0.8em;
color: var(--text-secondary);
margin-top: 4px;
}

.recent-terms {
margin-bottom: 20px;
}

.recent-terms h2 {
font-size: 1em;
margin-bottom: 12px;
color: var(--text-secondary);
font-weight: 500;
padding-left: 4px;
}

.recent-terms ul {
list-style: none;
padding: 0;
display: flex;
flex-wrap: wrap;
gap: 8px;
}

.recent-terms li {
background-color: rgba(142, 142, 147, 0.12);
border-radius: 50px;
padding: 8px 16px;
cursor: pointer;
transition: background-color 0.2s;
font-size: 14px;
}

.recent-terms li:hover {
background-color: rgba(142, 142, 147, 0.18);
}

.grid-container {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
margin-bottom: 20px;
}

.grid-item {
background-color: var(--card-color);
border-radius: var(--border-radius);
padding: 20px;
text-align: center;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
cursor: pointer;
transition: transform 0.2s, background-color 0.2s;
box-shadow: var(--shadow);
}

.grid-item:hover {
transform: translateY(-2px);
background-color: rgba(142, 142, 147, 0.05);
}

.grid-item .material-icons {
font-size: 32px;
margin-bottom: 12px;
color: var(--primary-color);
background-color: rgba(0, 122, 255, 0.1);
width: 60px;
height: 60px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
}

.grid-item p {
margin-bottom: 0;
font-weight: 500;
}

.map-section {
border-radius: var(--border-radius);
padding: 0;
text-align: center;
margin-bottom: 20px;
position: relative;
overflow: hidden;
box-shadow: var(--shadow);
}

#map {
height: 400px;
width: 100%;
border-radius: var(--border-radius);
}

#map-full {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.8);
z-index: 1000;
display: none;
border-radius: 0;
}

#map-full .leaflet-container {
height: 100%;
width: 100%;
}

.bottom-nav {
background-color: var(--card-color);
width: 100%;
display: flex;
justify-content: space-around;
padding: 10px 0;
position: fixed;
bottom: 0;
left: 0;
z-index: 1000;
box-shadow: 0px -2px 10px rgba(0,0,0,0.05);
box-sizing: border-box;
border-top: 1px solid rgba(142, 142, 147, 0.1);
}

.bottom-nav .material-icons {
font-size: 28px;
padding: 8px;
border-radius: 50%;
transition: background-color 0.2s;
color: var(--text-secondary);
}

.bottom-nav .material-icons.active {
color: var(--primary-color);
}

.bottom-nav .material-icons:hover {
background-color: rgba(142, 142, 147, 0.1);
}

.close-button {
position: absolute;
top: 20px;
right: 20px;
color: white;
font-size: 30px;
cursor: pointer;
z-index: 1001;
display: none;
background-color: rgba(0, 0, 0, 0.6);
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
}

#initial-content {
display: block;
}

#map-content {
display: none;
}

#list-content {
display: none;
}

#settings-content {
display: none;
}

.list-container {
padding: 20px;
border-radius: var(--border-radius);
background-color: var(--card-color);
margin-top: 20px;
box-shadow: var(--shadow);
}

.list-container h2 {
margin-bottom: 16px;
text-align: center;
font-weight: 600;
}

.list-container ul {
list-style: none;
padding: 0;
margin-bottom: 20px;
}

.list-container li {
padding: 14px 16px;
border-bottom: 1px solid rgba(142, 142, 147, 0.1);
cursor: pointer;
transition: background-color 0.2s;
}

.list-container li:hover {
background-color: rgba(142, 142, 147, 0.08);
}

.list-container li:last-child {
border-bottom: none;
}

.settings-container {
padding: 20px;
border-radius: var(--border-radius);
background-color: var(--card-color);
margin-top: 20px;
box-shadow: var(--shadow);
}

.settings-container h2 {
margin-bottom: 20px;
text-align: center;
font-weight: 600;
}

.settings-container label {
display: block;
margin-bottom: 8px;
font-weight: 500;
color: var(--text-primary);
}

.settings-container input[type="number"] {
width: 100%;
padding: 12px;
border: 1px solid rgba(142, 142, 147, 0.2);
border-radius: 8px;
margin-bottom: 16px;
font-size: 16px;
background-color: var(--background-color);
}

.settings-container button {
background-color: var(--primary-color);
color: white;
padding: 12px 20px;
border: none;
border-radius: 8px;
cursor: pointer;
font-weight: 500;
font-size: 16px;
width: 100%;
transition: opacity 0.2s;
}

.settings-container button:hover {
opacity: 0.9;
}

.history-list {
margin-top: 20px;
max-height: 300px;
overflow-y: auto;
}

.history-item {
padding: 12px 16px;
border-bottom: 1px solid rgba(142, 142, 147, 0.1);
cursor: pointer;
transition: background-color 0.2s;
}

.history-item:hover {
background-color: rgba(142, 142, 147, 0.08);
}

.history-item strong {
display: block;
margin-bottom: 4px;
}

.history-item small {
color: var(--text-secondary);
font-size: 0.8em;
}

#clear-history {
background-color: transparent;
color: var(--primary-color);
border: 1px solid var(--primary-color);
margin-top: 16px;
}

#clear-history:hover {
background-color: rgba(0, 122, 255, 0.1);
}

.leaflet-routing-container {
background-color: var(--card-color);
padding: 10px;
border-radius: 10px;
box-shadow: var(--shadow);
margin-bottom: 20px;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

.leaflet-routing-alternatives-container {
display: none;
}

.leaflet-routing-route {
color: var(--primary-color);
padding: 5px;
border-radius: 5px;
margin-bottom: 5px;
}

.leaflet-routing-route:hover {
background-color: rgba(142, 142, 147, 0.08);
cursor: pointer;
}

.selected-stop-icon {
background-color: #FF9500;
border-radius: 50%;
width: 20px;
height: 20px;
border: 2px solid white;
}

.user-location-icon {
background-color: var(--primary-color);
border-radius: 50%;
width: 20px;
height: 20px;
border: 2px solid white;
}

.metro-line-1 {
color: #FF3B30;
}

.metro-line-2 {
color: #007AFF;
}

.metro-line-3 {
color: #34C759;
}
</style>
</head>
<body>
<div class="container" id="initial-content">
<h1>Transportes</h1>
<div class="search-container">
<div class="search-bar">
<input type="text" id="search-input" placeholder="Buscar parada o línea">
<button class="search-button" id="search-button">
<span class="material-icons">search</span>
</button>
</div>
<div class="suggestions-container" id="suggestions">
</div>
</div>
<div class="recent-terms">
<h2>Términos recientes</h2>
<ul id="recent-terms-list">
</ul>
</div>
<div class="grid-container">
<div class="grid-item" id="map-button">
<span class="material-icons">map</span>
<p>Mapa</p>
</div>
<div class="grid-item" id="list-button">
<span class="material-icons">list</span>
<p>Lista</p>
</div>
<div class="grid-item" id="settings-button">
<span class="material-icons">settings</span>
<p>Configuración</p>
</div>
</div>
</div>

<div class="container" id="map-content">
<div class="map-section">
<div id="map"></div>
<div id="map-full">
<span class="close-button" id="close-map">&times;</span>
</div>
</div>
</div>

<div class="container" id="list-content">
<div class="list-container">
<h2>Paradas del Metro</h2>
<div id="metro-list"></div>
</div>
</div>

<div class="container" id="settings-content">
<div class="settings-container">
<h2>Configuración</h2>
<label for="latitude">Latitud:</label>
<input type="number" id="latitude" placeholder="Ej: 19.0417" value="19.0417">
<label for="longitude">Longitud:</label>
<input type="number" id="longitude" placeholder="Ej: -98.2000" value="-98.2000">
<button id="save-location">Guardar Ubicación</button>

<h3 style="margin-top: 20px;">Historial de Rutas</h3>
<div class="history-list" id="route-history">
</div>
<button id="clear-history">Limpiar Historial</button>
</div>
</div>

<div class="bottom-nav">
<span class="material-icons active" id="nav-home">home</span>
<span class="material-icons" id="nav-list">list</span>
<span class="material-icons" id="nav-map">map</span>
<span class="material-icons" id="nav-settings">settings</span>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.1/dist/leaflet-routing-machine.js"></script>
<script>
// Inicializar el mapa principal
var map = L.map('map').setView([19.0417, -98.2000], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Inicializar el mapa en pantalla completa
var mapFull = L.map('map-full', {
attributionControl: false,
}).setView([19.0417, -98.2000], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(mapFull);

var metroRoutes = [
{
name: "Línea 1",
color: "#FF3B30",
stops: [
{ name: "Estación 1-1 - Centro", coordinates: [19.0500, -98.2100] },
{ name: "Estación 1-2 - Universidad", coordinates: [19.0450, -98.2050] },
{ name: "Estación 1-3 - Mercado", coordinates: [19.0400, -98.2000] },
{ name: "Estación 1-4 - Parque", coordinates: [19.0350, -98.1950] },
{ name: "Estación 1-5 - Terminal", coordinates: [19.0300, -98.1900] }
]
},
{
name: "Línea 2",
color: "#007AFF",
stops: [
{ name: "Estación 2-1 - Norte", coordinates: [19.0600, -98.2200] },
{ name: "Estación 2-2 - Hospital", coordinates: [19.0550, -98.2150] },
{ name: "Estación 2-3 - Centro", coordinates: [19.0500, -98.2100] },
{ name: "Estación 2-4 - Escuela", coordinates: [19.0450, -98.2050] },
{ name: "Estación 2-5 - Sur", coordinates: [19.0400, -98.2000] }
]
},
{
name: "Línea 3",
color: "#34C759",
stops: [
{ name: "Estación 3-1 - Este", coordinates: [19.0700, -98.2300] },
{ name: "Estación 3-2 - Estadio", coordinates: [19.0650, -98.2250] },
{ name: "Estación 3-3 - Centro Comercial", coordinates: [19.0600, -98.2200] },
{ name: "Estación 3-4 - Oficinas", coordinates: [19.0550, -98.2150] },
{ name: "Estación 3-5 - Oeste", coordinates: [19.0500, -98.2100] }
]
}
];

// Variables globales
let userLocationMarker;
let selectedStopMarker = null;
let routingControl = null;
let mapFullRoutingControl = null;
let mapCenter = [19.0417, -98.2000];
let currentLocation = [19.0417, -98.2000];
let routeHistory = JSON.parse(localStorage.getItem('routeHistory')) || [];
let recentSearches = JSON.parse(localStorage.getItem('recentSearches')) || ["Centro", "Línea 1", "Estación 2-3"];
let metroMarkers = [];
let metroLines = [];

// Elementos del DOM
const searchInput = document.getElementById('search-input');
const searchButton = document.getElementById('search-button');
const suggestionsContainer = document.getElementById('suggestions');
const mapButton = document.getElementById('map-button');
const mapFullContainer = document.getElementById('map-full');
const closeMapButton = document.getElementById('close-map');
const initialContent = document.getElementById('initial-content');
const mapContent = document.getElementById('map-content');
const listContent = document.getElementById('list-content');
const settingsContent = document.getElementById('settings-content');
const bottomNav = document.querySelector('.bottom-nav');
const listButton = document.getElementById('list-button');
const metroListContainer = document.getElementById('metro-list');
const settingsButton = document.getElementById('settings-button');
const saveLocationButton = document.getElementById('save-location');
const latitudeInput = document.getElementById('latitude');
const longitudeInput = document.getElementById('longitude');
const recentTermsList = document.getElementById('recent-terms-list');
const routeHistoryContainer = document.getElementById('route-history');
const clearHistoryButton = document.getElementById('clear-history');
const navHome = document.getElementById('nav-home');
const navList = document.getElementById('nav-list');
const navMap = document.getElementById('nav-map');
const navSettings = document.getElementById('nav-settings');

// Inicialización
function initialize() {
drawMetroRoutes(map);
drawMetroRoutes(mapFull);
updateUserLocation(mapCenter[0], mapCenter[1]);
updateRouteHistoryDisplay();
updateRecentSearchesDisplay();
setupEventListeners();
loadMetroList();
}

function drawMetroRoutes(mapToDraw) {
// Limpiar marcadores y líneas existentes
clearMetroRoutes(mapToDraw);

// Dibujar solo las paradas cercanas (dentro de 2km)
const nearbyStops = getNearbyStops(currentLocation, 2000); // 2000 metros = 2km

metroRoutes.forEach(route => {
// Filtrar solo las paradas cercanas para esta línea
const routeStops = route.stops.filter(stop =>
nearbyStops.some(ns => ns.name === stop.name && ns.line === route.name)
);

if (routeStops.length > 0) {
// Dibujar la línea solo si tiene paradas cercanas
const line = L.polyline(routeStops.map(stop => stop.coordinates), {
color: route.color,
weight: 5,
opacity: 0.7
}).addTo(mapToDraw);

metroLines.push({map: mapToDraw, line: line});

// Dibujar marcadores para las paradas cercanas
routeStops.forEach(stop => {
const marker = L.marker(stop.coordinates)
.bindPopup(`<b>${route.name} - ${stop.name}</b>`)
.addTo(mapToDraw);

metroMarkers.push({map: mapToDraw, marker: marker});

marker.on('click', function(e) {
showStopDetails(stop, route);
});
});
}
});
}

function clearMetroRoutes(mapToDraw) {
// Eliminar marcadores específicos de este mapa
metroMarkers
.filter(m => m.map === mapToDraw)
.forEach(m => {
m.map.removeLayer(m.marker);
});
metroMarkers = metroMarkers.filter(m => m.map !== mapToDraw);

// Eliminar líneas específicas de este mapa
metroLines
.filter(l => l.map === mapToDraw)
.forEach(l => {
l.map.removeLayer(l.line);
});
metroLines = metroLines.filter(l => l.map !== mapToDraw);
}

function getNearbyStops(location, maxDistance) {
const nearbyStops = [];

metroRoutes.forEach(route => {
route.stops.forEach(stop => {
const distance = L.latLng(location).distanceTo(L.latLng(stop.coordinates));
if (distance <= maxDistance) {
nearbyStops.push({
name: stop.name,
line: route.name,
coordinates: stop.coordinates,
distance: distance
});
}
});
});

// Ordenar por distancia (más cercanas primero)
nearbyStops.sort((a, b) => a.distance - b.distance);

return nearbyStops;
}

function updateUserLocation(lat, lng) {
currentLocation = [lat, lng];
mapCenter = [lat, lng];
map.setView(mapCenter, 13);
mapFull.setView(mapCenter, 13);

if (userLocationMarker) {
map.removeLayer(userLocationMarker);
mapFull.removeLayer(userLocationMarker);
}

const userIcon = L.divIcon({
className: 'user-location-icon',
html: '<div style="background-color: #007AFF; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white;"></div>',
iconSize: [24, 24]
});

userLocationMarker = L.marker(currentLocation, {icon: userIcon})
.bindPopup("<b>Tu ubicación</b>")
.addTo(map);

L.marker(currentLocation, {icon: userIcon})
.bindPopup("<b>Tu ubicación</b>")
.addTo(mapFull);

// Actualizar rutas mostradas basadas en la nueva ubicación
drawMetroRoutes(map);
drawMetroRoutes(mapFull);
}

function searchStops(query) {
if (!query) return [];

const results = [];
const lowerQuery = query.toLowerCase();

// Buscar solo en paradas cercanas (dentro de 2km)
const nearbyStops = getNearbyStops(currentLocation, 2000);

nearbyStops.forEach(stop => {
if (stop.name.toLowerCase().includes(lowerQuery)) {
const route = metroRoutes.find(r => r.name === stop.line);
if (route) {
const routeStop = route.stops.find(s => s.name === stop.name);
if (routeStop) {
results.push({
name: stop.name,
line: route.name,
coordinates: stop.coordinates,
stopData: routeStop,
routeData: route
});
}
}
}
});

// También buscar por nombre de línea
metroRoutes.forEach(route => {
if (route.name.toLowerCase().includes(lowerQuery)) {
route.stops.forEach(stop => {
if (nearbyStops.some(ns => ns.name === stop.name && ns.line === route.name)) {
results.push({
name: stop.name,
line: route.name,
coordinates: stop.coordinates,
stopData: stop,
routeData: route
});
}
});
}
});

// Eliminar duplicados
const uniqueResults = results.filter((result, index, self) =>
index === self.findIndex((t) => (
t.name === result.name && t.line === result.line
))
);

// Ordenar por distancia
uniqueResults.sort((a, b) => {
const aDistance = L.latLng(currentLocation).distanceTo(L.latLng(a.coordinates));
const bDistance = L.latLng(currentLocation).distanceTo(L.latLng(b.coordinates));
return aDistance - bDistance;
});

return uniqueResults;
}

function clearExistingRoutes() {
if (routingControl) {
map.removeControl(routingControl);
routingControl = null;
}
if (mapFullRoutingControl) {
mapFull.removeControl(mapFullRoutingControl);
mapFullRoutingControl = null;
}
}

function showRouteToStop(stopCoordinates, stopName, lineName) {
clearExistingRoutes();

// Ocultar todas las paradas y líneas excepto la seleccionada
clearMetroRoutes(map);
clearMetroRoutes(mapFull);

// Guardar en el historial
const routeInfo = {
from: currentLocation,
to: stopCoordinates,
stopName: stopName,
lineName: lineName,
date: new Date().toLocaleString()
};

// Evitar duplicados
const isDuplicate = routeHistory.some(item =>
item.stopName === stopName &&
item.lineName === lineName &&
item.date === routeInfo.date
);

if (!isDuplicate) {
routeHistory.unshift(routeInfo);
if (routeHistory.length > 10) {
routeHistory.pop();
}
localStorage.setItem('routeHistory', JSON.stringify(routeHistory));
updateRouteHistoryDisplay();
}

// Guardar en búsquedas recientes
const searchTerm = `${stopName} (${lineName})`;
if (!recentSearches.includes(searchTerm)) {
recentSearches.unshift(searchTerm);
if (recentSearches.length > 5) {
recentSearches.pop();
}
localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
updateRecentSearchesDisplay();
}

// Crear la ruta en el mapa principal
routingControl = L.Routing.control({
waypoints: [
L.latLng(currentLocation),
L.latLng(stopCoordinates)
],
routeWhileDragging: false,
showAlternatives: false,
addWaypoints: false,
lineOptions: {
styles: [{color: '#007AFF', opacity: 0.7, weight: 5}]
},
createMarker: function() { return null; }
}).addTo(map);

// Crear la ruta en el mapa de pantalla completa
mapFullRoutingControl = L.Routing.control({
waypoints: [
L.latLng(currentLocation),
L.latLng(stopCoordinates)
],
routeWhileDragging: false,
showAlternatives: false,
addWaypoints: false,
lineOptions: {
styles: [{color: '#007AFF', opacity: 0.7, weight: 5}]
},
createMarker: function() { return null; }
}).addTo(mapFull);

// Mostrar información de la ruta
routingControl.on('routesfound', function(e) {
const routes = e.routes;
const summary = routes[0].summary;

const routeInfo = document.createElement('div');
routeInfo.innerHTML = `
<b>Ruta a ${stopName}</b><br>
Línea: ${lineName}<br>
Distancia: ${(summary.totalDistance / 1000).toFixed(2)} km<br>
Tiempo estimado: ${Math.round(summary.totalTime / 60)} minutos
`;

userLocationMarker.bindPopup(routeInfo).openPopup();
});
}

function selectStop(suggestion) {
searchInput.value = suggestion.name;
suggestionsContainer.style.display = 'none';
searchButton.style.display = 'none';

// Cambiar a la vista del mapa
showMapView();

// Centrar el mapa en la parada seleccionada
map.setView(suggestion.coordinates, 15);
mapFull.setView(suggestion.coordinates, 15);

// Actualizar marcador de parada seleccionada
updateSelectedStopMarker(suggestion.coordinates, suggestion.name, suggestion.line);

// Mostrar la ruta
showRouteToStop(suggestion.coordinates, suggestion.name, suggestion.line);
}

function updateSelectedStopMarker(coordinates, name, line) {
if (selectedStopMarker) {
map.removeLayer(selectedStopMarker);
mapFull.removeLayer(selectedStopMarker);
}

const stopIcon = L.divIcon({
className: 'selected-stop-icon',
html: '<div style="background-color: #FF9500; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white;"></div>',
iconSize: [24, 24]
});

selectedStopMarker = L.marker(coordinates, {icon: stopIcon})
.bindPopup(`<b>${line}</b><br>${name}`)
.addTo(map);

L.marker(coordinates, {icon: stopIcon})
.bindPopup(`<b>${line}</b><br>${name}`)
.addTo(mapFull);
}

function showStopDetails(stop, route) {
// Cambiar a la vista del mapa
showMapView();

// Centrar el mapa en la parada seleccionada
map.setView(stop.coordinates, 15);
mapFull.setView(stop.coordinates, 15);

// Actualizar marcador de parada seleccionada
updateSelectedStopMarker(stop.coordinates, stop.name, route.name);

// Mostrar la ruta
showRouteToStop(stop.coordinates, stop.name, route.name);
}

function showMapView() {
initialContent.style.display = 'none';
mapContent.style.display = 'block';
listContent.style.display = 'none';
settingsContent.style.display = 'none';
mapFullContainer.style.display = 'block';
closeMapButton.style.display = 'block';
bottomNav.style.display = 'flex';
mapFull.invalidateSize();

// Actualizar navegación
updateNavigation('map');
}

function showSuggestions(query) {
const suggestions = searchStops(query);
suggestionsContainer.innerHTML = '';

if (suggestions.length === 0) {
suggestionsContainer.style.display = 'none';
return;
}

suggestions.forEach(suggestion => {
const item = document.createElement('div');
item.className = 'suggestion-item';
item.innerHTML = `
<div>${suggestion.name}</div>
<div class="line">${suggestion.line}</div>
`;

item.addEventListener('click', () => {
selectStop(suggestion);
});

suggestionsContainer.appendChild(item);
});

suggestionsContainer.style.display = 'block';
}

function loadMetroList() {
metroListContainer.innerHTML = '';

// Mostrar solo paradas cercanas (dentro de 2km)
const nearbyStops = getNearbyStops(currentLocation, 2000);

metroRoutes.forEach(route => {
// Filtrar solo las paradas cercanas para esta línea
const routeStops = route.stops.filter(stop =>
nearbyStops.some(ns => ns.name === stop.name && ns.line === route.name)
);

if (routeStops.length > 0) {
const routeList = document.createElement('ul');
routeList.innerHTML = `<h3 class="metro-line-${metroRoutes.indexOf(route) + 1}">${route.name}</h3>`;

routeStops.forEach(stop => {
const stopItem = document.createElement('li');
stopItem.innerHTML = `
<div>${stop.name}</div>
<small class="metro-line-${metroRoutes.indexOf(route) + 1}">${route.name}</small>
`;

stopItem.addEventListener('click', () => {
showStopDetails(stop, route);
});

routeList.appendChild(stopItem);
});

metroListContainer.appendChild(routeList);
}
});
}

function updateRouteHistoryDisplay() {
routeHistoryContainer.innerHTML = '';

if (routeHistory.length === 0) {
routeHistoryContainer.innerHTML = '<p>No hay rutas en el historial</p>';
return;
}

routeHistory.forEach((route, index) => {
const item = document.createElement('div');
item.className = 'history-item';
item.innerHTML = `
<div><strong>${route.stopName}</strong></div>
<div>Línea: ${route.lineName}</div>
<small>${route.date}</small>
`;

item.addEventListener('click', () => {
showMapView();

// Centrar el mapa en la parada seleccionada
map.setView(route.to, 15);
mapFull.setView(route.to, 15);

// Actualizar ubicación actual
currentLocation = route.from;
updateUserLocation(route.from[0], route.from[1]);

// Actualizar marcador de parada seleccionada
updateSelectedStopMarker(route.to, route.stopName, route.lineName);

// Mostrar la ruta
showRouteToStop(route.to, route.stopName, route.lineName);
});

routeHistoryContainer.appendChild(item);
});
}

function updateRecentSearchesDisplay() {
recentTermsList.innerHTML = '';

if (recentSearches.length === 0) {
recentTermsList.innerHTML = '<li>No hay búsquedas recientes</li>';
return;
}

recentSearches.forEach(term => {
const item = document.createElement('li');
item.textContent = term;

item.addEventListener('click', () => {
// Buscar directamente el término
const suggestions = searchStops(term);
if (suggestions.length > 0) {
selectStop(suggestions[0]);
} else {
alert('No se encontraron resultados para: ' + term);
}
});

recentTermsList.appendChild(item);
});
}

function updateNavigation(activeView) {
// Reset all icons
navHome.classList.remove('active');
navList.classList.remove('active');
navMap.classList.remove('active');
navSettings.classList.remove('active');

// Set active icon
switch(activeView) {
case 'home':
navHome.classList.add('active');
break;
case 'list':
navList.classList.add('active');
break;
case 'map':
navMap.classList.add('active');
break;
case 'settings':
navSettings.classList.add('active');
break;
}
}

function setupEventListeners() {
// Buscador
searchInput.addEventListener('input', (e) => {
if (e.target.value.trim() !== '') {
searchButton.style.display = 'block';
showSuggestions(e.target.value);
} else {
searchButton.style.display = 'none';
suggestionsContainer.style.display = 'none';
}
});

searchInput.addEventListener('focus', () => {
if (searchInput.value) {
showSuggestions(searchInput.value);
}
});

searchButton.addEventListener('click', () => {
const query = searchInput.value.trim();
if (query !== '') {
const suggestions = searchStops(query);
if (suggestions.length > 0) {
selectStop(suggestions[0]);
} else {
alert('No se encontraron resultados para: ' + query);
}
}
});

searchInput.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
searchButton.click();
}
});

document.addEventListener('click', (e) => {
if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
suggestionsContainer.style.display = 'none';
}
});

// Navegación
mapButton.addEventListener('click', () => {
showMapView();
});

closeMapButton.addEventListener('click', () => {
mapFullContainer.style.display = 'none';
closeMapButton.style.display = 'none';
mapContent.style.display = 'none';
initialContent.style.display = 'block';
listContent.style.display = 'none';
settingsContent.style.display = 'none';
bottomNav.style.display = 'flex';
updateNavigation('home');

// Restaurar la visualización de rutas cercanas
drawMetroRoutes(map);
drawMetroRoutes(mapFull);
});

navHome.addEventListener('click', () => {
initialContent.style.display = 'block';
mapContent.style.display = 'none';
listContent.style.display = 'none';
settingsContent.style.display = 'none';
mapFullContainer.style.display = 'none';
closeMapButton.style.display = 'none';
bottomNav.style.display = 'flex';
updateNavigation('home');

// Restaurar la visualización de rutas cercanas
drawMetroRoutes(map);
drawMetroRoutes(mapFull);
});

listButton.addEventListener('click', () => {
initialContent.style.display = 'none';
mapContent.style.display = 'none';
listContent.style.display = 'block';
settingsContent.style.display = 'none';
bottomNav.style.display = 'flex';
updateNavigation('list');
});

navList.addEventListener('click', () => {
initialContent.style.display = 'none';
mapContent.style.display = 'none';
listContent.style.display = 'block';
settingsContent.style.display = 'none';
bottomNav.style.display = 'flex';
updateNavigation('list');
});

navMap.addEventListener('click', () => {
showMapView();
});

settingsButton.addEventListener('click', () => {
initialContent.style.display = 'none';
mapContent.style.display = 'none';
listContent.style.display = 'none';
settingsContent.style.display = 'block';
bottomNav.style.display = 'flex';
updateNavigation('settings');
});

navSettings.addEventListener('click', () => {
initialContent.style.display = 'none';
mapContent.style.display = 'none';
listContent.style.display = 'none';
settingsContent.style.display = 'block';
bottomNav.style.display = 'flex';
updateNavigation('settings');
});

// Configuración
saveLocationButton.addEventListener('click', () => {
const lat = parseFloat(latitudeInput.value);
const lng = parseFloat(longitudeInput.value);

if (!isNaN(lat) && !isNaN(lng)) {
updateUserLocation(lat, lng);
alert('Ubicación guardada correctamente.');
initialContent.style.display = 'block';
settingsContent.style.display = 'none';
updateNavigation('home');
} else {
alert('Por favor, introduce valores de latitud y longitud válidos.');
}
});

// Historial
clearHistoryButton.addEventListener('click', () => {
routeHistory = [];
localStorage.setItem('routeHistory', JSON.stringify(routeHistory));
updateRouteHistoryDisplay();
});

// Mapa
map.on('click', (e) => {
let closestStop = null;
let minDistance = Infinity;
let closestRouteName = "";
let closestStopData = null;

metroRoutes.forEach(route => {
route.stops.forEach(stop => {
const distance = L.latLng(e.latlng).distanceTo(L.latLng(stop.coordinates));
if (distance < minDistance) {
minDistance = distance;
closestStop = stop.coordinates;
closestRouteName = route.name;
closestStopData = stop;
}
});
});

if (closestStop && minDistance < 500) {
showStopDetails(closestStopData, metroRoutes.find(r => r.name === closestRouteName));
}
});
}

// Iniciar la aplicación
initialize();
</script>

<script>
// Registro del Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('SW registrado:', registration);
      })
      .catch(error => {
        console.log('Error al registrar SW:', error);
      });
  });
}
</script>
</body>
</html>
