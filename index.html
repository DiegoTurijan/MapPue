<!DOCTYPE html>
<html>
<head>
    <title>Metro Puebla - Selecci√≥n Libre</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --apple-bg: #f2f2f7;
            --apple-card: #ffffff;
            --apple-blue: #007aff;
            --apple-gray: #8e8e93;
            --apple-text: #1c1c1e;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--apple-text);
            background: var(--apple-bg);
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { 
            height: 100vh; 
            width: 100vw;
            position: fixed;
            top: 0;
            z-index: 0;
        }
        
        .control-panel {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background: var(--apple-card);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .mode-selector {
            display: flex;
            margin-bottom: 12px;
            background: #e5e5ea;
            border-radius: 10px;
            padding: 4px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .mode-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .station-selector {
            margin-top: 12px;
        }
        
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #e5e5ea;
            border-radius: 10px;
            background-color: var(--apple-card);
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        .calculate-btn {
            width: 100%;
            background: var(--apple-blue);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .route-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--apple-card);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 60vh;
            overflow-y: auto;
            display: none;
        }
        
        .route-step {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 12px;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-line {
            font-weight: 500;
            font-size: 14px;
        }
        
        .step-station {
            font-size: 16px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: var(--apple-card);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        
        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--apple-gray);
            font-size: 12px;
            padding: 8px;
        }
        
        .tab.active {
            color: var(--apple-blue);
        }
        
        .tab-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .custom-point-popup {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .hide-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001; /* Asegura que el bot√≥n est√© por encima de otros elementos */
            font-size: 0.8em;
        }

        .hidden {
            display: none !important;
        }
        
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="control-panel" class="control-panel">
        <button id="hide-control-panel-btn" class="hide-button">Ocultar</button>
        <div class="mode-selector">
            <button id="mode-origin" class="mode-btn active">Origen</button>
            <button id="mode-destination" class="mode-btn">Destino</button>
        </div>
        
        <div class="station-selector">
            <select id="metro-station">
                <option value="">Seleccionar estaci√≥n de metro</option>
            </select>
            <div style="text-align: center; margin: 10px 0; color: var(--apple-gray)">o</div>
            <button id="select-on-map" class="calculate-btn" style="background: #34C759;">Seleccionar en el mapa</button>
        </div>
        
        <button id="calculate-route" class="calculate-btn">Calcular Ruta</button>
    </div>
    
    <div id="route-panel" class="route-panel">
        <button id="hide-route-panel-btn" class="hide-button">Ocultar</button>
        <h3 style="margin-top:0;">Instrucciones de Ruta</h3>
        <div id="route-steps"></div>
    </div>
    
    <div class="tab-bar">
        <div class="tab active">
            <div class="tab-icon">üó∫Ô∏è</div>
            <div>Mapa</div>
        </div>
        <div class="tab">
            <div class="tab-icon">‚≠ê</div>
            <div>Favoritos</div>
        </div>
    </div>

    <script>
        // Datos del Metro de Puebla
        const metroData = {
            lineas: {
                "L1": {
                    color: "#FF3B30",
                    estaciones: [
                        {id: "l1-1", nombre: "Chachapa", coords: [19.0600, -98.2000]},
                        {id: "l1-2", nombre: "San Francisco", coords: [19.0500, -98.2050]},
                        {id: "l1-3", nombre: "Centro", coords: [19.0414, -98.2063], transfer: ["L2", "L3"]},
                        {id: "l1-4", nombre: "Angel√≥polis", coords: [19.0350, -98.2100]},
                        {id: "l1-5", nombre: "Valsequillo", coords: [19.0250, -98.2150]}
                    ]
                },
                "L2": {
                    color: "#007AFF",
                    estaciones: [
                        {id: "l2-1", nombre: "Zavaleta", coords: [19.0450, -98.1800]},
                        {id: "l2-2", nombre: "Universidades", coords: [19.0420, -98.1900]},
                        {id: "l2-3", nombre: "Centro", coords: [19.0414, -98.2063], transfer: ["L1", "L3"]},
                        {id: "l2-4", nombre: "Xonaca", coords: [19.0400, -98.2200]},
                        {id: "l2-5", nombre: "San Pedro", coords: [19.0380, -98.2300]}
                    ]
                },
                "L3": {
                    color: "#34C759",
                    estaciones: [
                        {id: "l3-1", nombre: "Terminal CAPU", coords: [19.0700, -98.1900]},
                        {id: "l3-2", nombre: "San Manuel", coords: [19.0600, -98.1950]},
                        {id: "l3-3", nombre: "Centro", coords: [19.0414, -98.2063], transfer: ["L1", "L2"]},
                        {id: "l3-4", nombre: "La Paz", coords: [19.0300, -98.2000]},
                        {id: "l3-5", nombre: "Los Fuertes", coords: [19.0200, -98.1950]}
                    ]
                }
            },
            grafo: {
                "l1-1": ["l1-2"],
                "l1-2": ["l1-1", "l1-3"],
                "l1-3": ["l1-2", "l1-4", "l2-3", "l3-3"],
                "l1-4": ["l1-3", "l1-5"],
                "l1-5": ["l1-4"],
                
                "l2-1": ["l2-2"],
                "l2-2": ["l2-1", "l2-3"],
                "l2-3": ["l2-2", "l2-4", "l1-3", "l3-3"],
                "l2-4": ["l2-3", "l2-5"],
                "l2-5": ["l2-4"],
                
                "l3-1": ["l3-2"],
                "l3-2": ["l3-1", "l3-3"],
                "l3-3": ["l3-2", "l3-4", "l1-3", "l2-3"],
                "l3-4": ["l3-3", "l3-5"],
                "l3-5": ["l3-4"]
            }
        };

        // Variables globales
        let map;
        let startMarker, endMarker;
        let currentRoute = null;
        let stationMarkers = [];
        let customOrigin = null;
        let customDestination = null;
        let currentMode = 'origin'; // 'origin' or 'destination'
        let selectionMode = false;

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([19.0414, -98.2063], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            drawMetroLines();
            fillStationSelectors();
            setupEventListeners();
        }

        // Dibujar l√≠neas y estaciones
        function drawMetroLines() {
            Object.entries(metroData.lineas).forEach(([lineaId, linea]) => {
                // Dibujar l√≠nea
                const coords = linea.estaciones.map(e => e.coords);
                L.polyline(coords, {
                    color: linea.color,
                    weight: 6,
                    opacity: 0.8
                }).addTo(map);
                
                // Dibujar estaciones
                linea.estaciones.forEach(estacion => {
                    const icon = L.divIcon({
                        className: `station-icon ${estacion.transfer ? 'transfer' : ''}`,
                        html: `
                            <div style="
                                width: 24px;
                                height: 24px;
                                background: ${linea.color};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            ">
                                ${estacion.transfer ? '‚áÑ' : '‚Ä¢'}
                            </div>
                        `,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker(estacion.coords, {icon: icon})
                        .addTo(map)
                        .bindPopup(`
                            <div style="font-weight:600">${estacion.nombre}</div>
                            <div style="color:${linea.color}">L√≠nea ${lineaId}</div>
                        `);
                    
                    stationMarkers.push({
                        id: estacion.id,
                        marker: marker
                    });
                });
            });
        }

        // Llenar selector de estaciones
        function fillStationSelectors() {
            const metroSelect = document.getElementById('metro-station');
            
            Object.entries(metroData.lineas).forEach(([lineaId, linea]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = `L√≠nea ${lineaId}`;
                
                linea.estaciones.forEach(estacion => {
                    const option = document.createElement('option');
                    option.value = estacion.id;
                    option.textContent = estacion.nombre;
                    optgroup.appendChild(option);
                });
                
                metroSelect.appendChild(optgroup);
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Modo origen/destino
            document.getElementById('mode-origin').addEventListener('click', () => {
                currentMode = 'origin';
                document.getElementById('mode-origin').classList.add('active');
                document.getElementById('mode-destination').classList.remove('active');
            });
            
            document.getElementById('mode-destination').addEventListener('click', () => {
                currentMode = 'destination';
                document.getElementById('mode-destination').classList.add('active');
                document.getElementById('mode-origin').classList.remove('active');
            });
            
            // Seleccionar en el mapa
            document.getElementById('select-on-map').addEventListener('click', () => {
                selectionMode = true;
                alert("Toca cualquier lugar del mapa para seleccionar " + 
                     (currentMode === 'origin' ? 'el origen' : 'el destino'));
            });
            
            // Calcular ruta
            document.getElementById('calculate-route').addEventListener('click', calculateRoute);
            
            // Click en el mapa para selecci√≥n
            map.on('click', (e) => {
                if (selectionMode) {
                    const point = e.latlng;
                    
                    if (currentMode === 'origin') {
                        if (customOrigin) map.removeLayer(customOrigin);
                        customOrigin = L.marker(point, {
                            icon: L.divIcon({
                                html: '<div style="font-size:24px; text-shadow:0 2px 4px rgba(0,0,0,0.2)">üü¢</div>',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32]
                            })
                        }).addTo(map)
                        .bindPopup(`<div class="custom-point-popup"><b>Origen personalizado</b><br>${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}</div>`)
                        .openPopup();
                        
                        document.getElementById('metro-station').value = '';
                    } else {
                        if (customDestination) map.removeLayer(customDestination);
                        customDestination = L.marker(point, {
                            icon: L.divIcon({
                                html: '<div style="font-size:24px; text-shadow:0 2px 4px rgba(0,0,0,0.2)">üî¥</div>',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32]
                            })
                        }).addTo(map)
                        .bindPopup(`<div class="custom-point-popup"><b>Destino personalizado</b><br>${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}</div>`)
                        .openPopup();
                        
                        document.getElementById('metro-station').value = '';
                    }
                    
                    selectionMode = false;
                }
            });

            // Botones para ocultar paneles
            document.getElementById('hide-control-panel-btn').addEventListener('click', () => {
                document.getElementById('control-panel').classList.add('hidden');
            });

            document.getElementById('hide-route-panel-btn').addEventListener('click', () => {
                document.getElementById('route-panel').classList.add('hidden');
            });
            
            // Mostrar paneles al hacer clic en el mapa (opcional)
            map.on('click', () => {
                document.getElementById('control-panel').classList.remove('hidden');
                document.getElementById('route-panel').classList.remove('hidden');
            });
        }

        // Encontrar la estaci√≥n m√°s cercana a un punto
        function findNearestStation(point) {
            let minDistance = Infinity;
            let nearestStation = null;
            
            Object.values(metroData.lineas).forEach(linea => {
                linea.estaciones.forEach(estacion => {
                    const distance = map.distance(point, estacion.coords);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStation = estacion;
                    }
                });
            });
            
            return nearestStation;
        }

        // Calcular ruta
        function calculateRoute() {
            // Obtener puntos de inicio y fin
            const metroStationId = document.getElementById('metro-station').value;
            let startPoint, endPoint;
            
            // Determinar origen
            if (customOrigin) {
                startPoint = {
                    coords: customOrigin.getLatLng(),
                    custom: true,
                    nearestStation: findNearestStation(customOrigin.getLatLng())
                };
            } else if (metroStationId && currentMode === 'origin') {
                startPoint = {
                    coords: findStationById(metroStationId).coords,
                    custom: false,
                    station: findStationById(metroStationId)
                };
            } else {
                alert("Selecciona un origen");
                return;
            }
            
            // Determinar destino
            if (customDestination) {
                endPoint = {
                    coords: customDestination.getLatLng(),
                    custom: true,
                    nearestStation: findNearestStation(customDestination.getLatLng())
                };
            } else if (metroStationId && currentMode === 'destination') {
                endPoint = {
                    coords: findStationById(metroStationId).coords,
                    custom: false,
                    station: findStationById(metroStationId)
                };
            } else {
                alert("Selecciona un destino");
                return;
            }
            
            // Limpiar ruta anterior
            resetMap();
            
            // Si ambos puntos son personalizados, mostrar ruta directa
            if (startPoint.custom && endPoint.custom) {
                showDirectRoute(startPoint, endPoint);
                return;
            }
            
            // Calcular ruta usando el metro
            let routeStations = [];
            
            // Si el origen es personalizado, empezar desde la estaci√≥n m√°s cercana
            if (startPoint.custom) {
                routeStations.push({
                    ...startPoint.nearestStation,
                    linea: findLineForStation(startPoint.nearestStation.id),
                    isFromCustom: true,
                    customPoint: startPoint.coords
                });
            } else {
                routeStations.push({
                    ...startPoint.station,
                    linea: findLineForStation(startPoint.station.id)
                });
            }
            
            // Si el destino es personalizado, terminar en la estaci√≥n m√°s cercana
            const targetStation = endPoint.custom ? endPoint.nearestStation : endPoint.station;
            
            // Calcular ruta entre estaciones
            const metroRoute = findRoute(routeStations[0].id, targetStation.id);
            
            if (!metroRoute || metroRoute.length === 0) {
                alert("No se encontr√≥ ruta");
                return;
            }
            
            // Agregar estaciones intermedias
            metroRoute.slice(1).forEach(stationId => {
                const station = findStationById(stationId);
                routeStations.push({
                    ...station,
                    linea: findLineForStation(stationId)
                });
            });
            
            // Si el destino es personalizado, agregar el punto final
            if (endPoint.custom) {
                routeStations.push({
                    ...endPoint.nearestStation,
                    linea: findLineForStation(endPoint.nearestStation.id),
                    isToCustom: true,
                    customPoint: endPoint.coords
                });
            }
            
            // Dibujar ruta completa
            drawCompleteRoute(routeStations, startPoint, endPoint);
            
        }

        function findStationById(id) {
            for (const linea of Object.values(metroData.lineas)) {
                for (const estacion of linea.estaciones) {
                    if (estacion.id === id) {
                        return estacion;
                    }
                }
            }
            return null;
        }

        function findLineForStation(stationId) {
            for (const [lineaId, linea] of Object.entries(metroData.lineas)) {
                if (linea.estaciones.find(e => e.id === stationId)) {
                    return lineaId;
                }
            }
            return null;
        }

        // Algoritmo de b√∫squeda de ruta (BFS)
        function findRoute(startId, endId) {
            const queue = [startId];
            const visited = new Set();
            const parentMap = new Map();
            
            visited.add(startId);
            
            while (queue.length > 0) {
                const currentId = queue.shift();
                
                if (currentId === endId) {
                    break;
                }
                
                const neighbors = metroData.grafo[currentId] || [];
                
                for (const neighborId of neighbors) {
                    if (!visited.has(neighborId)) {
                        visited.add(neighborId);
                        parentMap.set(neighborId, currentId);
                        queue.push(neighborId);
                    }
                }
            }
            
            // Reconstruir la ruta desde el final
            if (!parentMap.has(endId)) {
                return null; // No se encontr√≥ ruta
            }
            
            const route = [endId];
            let currentId = endId;
            while (currentId !== startId) {
                currentId = parentMap.get(currentId);
                route.unshift(currentId);
            }
            
            return route;
        }

        function resetMap() {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (currentRoute) map.removeLayer(currentRoute);
            currentRoute = null;
        }

        function showDirectRoute(startPoint, endPoint) {
             startMarker = L.marker(startPoint.coords, {
                icon: L.divIcon({
                    html: '<div style="font-size:24px; text-shadow:0 2px 4px rgba(0,0,0,0.2)">üü¢</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(map)
            .bindPopup(`<div class="custom-point-popup"><b>Origen</b><br>${startPoint.coords.lat.toFixed(4)}, ${startPoint.coords.lng.toFixed(4)}</div>`)
            .openPopup();
            
             endMarker = L.marker(endPoint.coords, {
                icon: L.divIcon({
                    html: '<div style="font-size:24px; text-shadow:0 2px 4px rgba(0,0,0,0.2)">üî¥</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(map)
            .bindPopup(`<div class="custom-point-popup"><b>Destino</b><br>${endPoint.coords.lat.toFixed(4)}, ${endPoint.coords.lng.toFixed(4)}</div>`)
            .openPopup();
            
            currentRoute = L.polyline([startPoint.coords, endPoint.coords], {
                color: '#800080',
                weight: 8,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            const routePanel = document.getElementById('route-panel');
            const routeStepsDiv = document.getElementById('route-steps');
            routeStepsDiv.innerHTML = `<div class="route-step">
                <div class="step-icon" style="background-color:#800080">Directo</div>
                <div class="step-content">
                    <div class="step-line">Ruta directa entre los puntos seleccionados.</div>
                    <div class="step-station">${startPoint.coords.lat.toFixed(4)}, ${startPoint.coords.lng.toFixed(4)}  ‚Üí  ${endPoint.coords.lat.toFixed(4)}, ${endPoint.coords.lng.toFixed(4)}</div>
                </div>
            </div>`;
            routePanel.style.display = 'block';
        }


        function drawCompleteRoute(routeStations, startPoint, endPoint) {
            const routeCoords = [];
            const routePanel = document.getElementById('route-panel');
            const routeStepsDiv = document.getElementById('route-steps');
            routeStepsDiv.innerHTML = ''; // Clear previous route
            
            routeStations.forEach((station, index) => {
                routeCoords.push(station.coords);
                
                const isFirst = index === 0;
                const isLast = index === routeStations.length - 1;
                
                let stepIconColor = '#007AFF'; // Default color
                if (station.linea === 'L1') stepIconColor = '#FF3B30';
                else if (station.linea === 'L2') stepIconColor = '#007AFF';
                else if (station.linea === 'L3') stepIconColor = '#34C759';
                
                let stepLineText = `L√≠nea ${station.linea}`;
                if (isFirst && station.isFromCustom) stepLineText = "Desde punto personalizado";
                else if (isLast && station.isToCustom) stepLineText = "Hasta punto personalizado";
                
                const stepDiv = document.createElement('div');
                stepDiv.className = 'route-step';
                
                const stepIconDiv = document.createElement('div');
                stepIconDiv.className = 'step-icon';
                stepIconDiv.style.backgroundColor = stepIconColor;
                stepIconDiv.textContent = isFirst ? 'üü¢' : isLast ? 'üî¥' : '‚Ä¢';
                
                const stepContentDiv = document.createElement('div');
                stepContentDiv.className = 'step-content';
                
                const stepLineDiv = document.createElement('div');
                stepLineDiv.className = 'step-line';
                stepLineDiv.textContent = stepLineText;
                
                const stepStationDiv = document.createElement('div');
                stepStationDiv.className = 'step-station';
                stepStationDiv.textContent = station.nombre;
                if(isFirst && station.isFromCustom){
                  stepStationDiv.textContent =  `Origen: ${startPoint.coords.lat.toFixed(4)}, ${startPoint.coords.lng.toFixed(4)} (Estaci√≥n m√°s cercana: ${station.nombre})`;
                }
                if(isLast && station.isToCustom){
                    stepStationDiv.textContent =  `Destino: ${endPoint.coords.lat.toFixed(4)}, ${endPoint.coords.lng.toFixed(4)} (Estaci√≥n m√°s cercana: ${station.nombre})`;
                }
                
                stepContentDiv.appendChild(stepLineDiv);
                stepContentDiv.appendChild(stepStationDiv);
                
                stepDiv.appendChild(stepIconDiv);
                stepDiv.appendChild(stepContentDiv);
                
                routeStepsDiv.appendChild(stepDiv);
            });
            
            // Dibujar la ruta en el mapa
            currentRoute = L.polyline(routeCoords, {
                color: '#800080',
                weight: 8,
                opacity: 0.7
            }).addTo(map);
            
            // Mostrar el panel de ruta
            routePanel.style.display = 'block';
        }


        // Inicializar la aplicaci√≥n
        initMap();
    </script>
</body>
</html>

